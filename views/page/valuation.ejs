<style>
	.datepicker {
		left: 34px!important;
	}
	.form-group {
		margin-bottom: 24px;
	}
	#carsupload {
		overflow-y: auto;
		padding: 40px 20px;
		border: 1px solid #ddd;
		border-radius: 2px;
		box-shadow: 3px 3px 7px #888;
	}
	.icon-angle-down:after{
		line-height: 34px;
		content: "\f107";
		font: normal normal normal 24px/1 FontAwesome;
		position: absolute;
		right: 10px;
		top: 13px;
		color: #999;
	}
	input[type="text"]{
		color:#999; border-color:#ccc;
		height:50px; line-height:50px;
		font-size: 19px; text-overflow: ellipsis;
		padding-left:20px; padding-right: 30px;
	}
	#divValuate{
		width:80%; height:60px; line-height:60px;
		background-color:#009aff; color:white;
		border-radius:3px;
		font-size:29px;
		text-align:center;
		margin:80px auto 0;
	}
</style>
<form id="carsuploadForm" action="/api/carEvaluateByCar" method="post" >
	<div id="carsupload">
		<div class="form-group">
			<span class="input-icon icon-left">
				<input id="txtCar" type="text" class="form-control" placeholder="选择车型" readonly="readonly">
				<input name="brand_id" type="hidden"/>
				<input name="series_id" type="hidden"/>
				<input name="model_id" type="hidden"/>
				<input id="txtTitle" name="title" type="hidden"/>
				<i class="icon-angle-down"></i>
			</span>
		</div>
		<div class="form-group">
			<span class="input-icon icon-left">
				<input id="txtAddress" type="text" class="form-control" placeholder="车源地" readonly="readonly" value="车源地：江苏/苏州">
				<input name="provid" type="hidden" value="11"/>
                <input name="cityid" type="hidden" value="125"/>
				<i class="icon-angle-down"></i>
			</span>
		</div>
		<div class="form-group">
			<span class="input-icon icon-left">
				<input id="txtRegisterDate" type="text" class="form-control date-picker" data-date-format="yyyy-mm" placeholder="上牌时间" readonly="readonly">
				<input name="register_date" type="hidden"/>
				<i class="icon-angle-down"></i>
			</span>
		</div>
		<div>
			<div id="divValuate">开始估值</div>
		</div>
	</div>
	<input id="btnSubmit" type="submit" style="display:none;">
</form>
<script src="../js/bootstrap-datepicker.js"></script>
<script src="../js/select2.js"></script>
<script>
	// 初始化日期控件
	// $('.date-picker').datepicker({
	// 	minViewMode: 'months',
	// 	viewMode:'months'
	// });

	function fzData(data, jg) {
		return (function(obj) {
			for (var o in jg) {
				obj[o] = jg[o];
			}
		})(data.parse(carEditData));
	}

	/*
	* 初始化布局
	**/
	function init() {
		var bl = true;
		// 生成数据结构
		sessionStorage.valuationData = sessionStorage.valuationData || "{}";
		$("#widget-bottom").hide();
		// 窗口高度调节
		(function(height) {
			$("#page-body").height(height).css("padding", "5px 5px");
			$("#carsupload").height(height - 23);
		})(document.documentElement.clientHeight - 68);

		// 初始化编辑
		initData(
			$("#carsupload"), 
			sessionStorage.valuationData,
			// 结构化
			[
				{ 
					id: "#txtCar", 
					names: ["brand_name", "series_name", "model_name"], 
					number: 3,
					prefix: "",
					suffix: ""
				},
				{
					id: "#txtAddress", 
					names: ["provname", "cityname"], 
					number: 2,
					prefix: "车源地：",
					suffix: ""      
				},
				{
					id: "#txtTitle",
					names: ["title"],
					number: 1,
					prefix: "",
					suffix: ""  
				},
				{
					id: "#txtRegisterDate",
					names: ["register_date"],
					number: 1,
					prefix: "上牌时间：",
					suffix: ""   
				}
			],
			function(data) {
			}
		);

		// 下一步
		$("#btnOperation,#divValuate").click(function() {
			// 数据缓存
			(function(obj) {
				$.each( $("#carsupload input"), function(i, n) {
					if($(n).prop("name")) {
						obj[$(n).prop("name")] = $(n).val();
					}
				});
				// 车
				(function(arrXc) {
					obj['brand_name'] = arrXc[0];
					obj['series_name'] = arrXc[1];
					obj['model_name'] = arrXc[2];
				})($("#txtCar").val().split("/"));
				// 地区
				(function(dq) {
					obj['provname'] = dq[0].split("：")[1];
					obj['cityname'] = dq[1];
				})($("#txtAddress").val().split("/"));
				// 数据缓存
				sessionStorage.valuationData = JSON.stringify(obj);
			})(JSON.parse(sessionStorage.valuationData));

			// 手动判断验证
			if ($validator.start({
				model_id: {
					notEmpty: {
						message: '* 请选择一款车'
					}
				},
				cityid: {
					notEmpty: {
						message: '* 请选择车源地'
					}
				},
				register_date: {
					notEmpty: {
						message: '* 请选择上牌时间'
					}
				},
			})) {
				$.ajax({
					url:'/api/carEvaluateByCar' + location.search,
					data:JSON.parse(sessionStorage.valuationData),
					type:'post',
					success:function(result){
						if(!result||result.errcode==400)return alert('没有车辆评估信息');
						var obj = JSON.parse(sessionStorage.valuationData);
						obj.price = result.errmsg;
						sessionStorage.valuationData = JSON.stringify(obj);
						location.href = '/open/valuationResult' + location.search;
					}
				})
			}
			return false;
		});

		// 选车
		$("#txtCar").click(function() {
			// d品牌数据获取
			$.ajax({
				url: "/api/carBrand",
				type: "post",
				success: function(msg) {
					// 品牌弹出层
					showModal(
						$("#modal-type-1-info"),
						{
							title: "品牌",
							msg: msg,
							text: "BrandName",
							value: "Innerid",
							col: 12,
							width: "80%",
							float: "right"
						}, function(data1, cb1) {
							// 车系数据获取
							$.ajax({
								url: "/api/carSeries",
								type: "post",
								data: {
									brandId: data1.value
								},
								success: function(msg) {
									// 车系弹出层
									showModal(
										$("#modal-type-2-info"),
										{
											title: "车系",
											msg: msg,
											text: "SeriesName",
											value: "Innerid",
											col: 12,
											width: "60%",
											float: "right"
										}, function(data2, cb2) {
											// 车型数据获取
											$.ajax({
												url: "/api/carModel",
												type: "post",
												data: {
													seriesId: data2.value
												},
												success: function(msg) {
													// 车型弹出层
													showModal(
														$("#modal-type-3-info"),
														{
															title: "车型",
															msg: msg,
															text: "Modelname",
															value: "Innerid",
															col: 12,
															width: "80%",
															float: "right"
														}, function(data3, cb3) {
															$("#txtCar").val(data1.text + "/" + data2.text + "/" + data3.text);
															$("input[name='title']").val(data1.text + "/" + data2.text);
															$("input[name='brand_id']").val(data1.value);
															$("input[name='series_id']").val(data2.value);
															$("input[name='model_id']").val(data3.value);
															$("#modal-type-3-info .closed").click();
															$("#modal-type-2-info .closed").click();
															$("#modal-type-1-info .closed").click();
															$("input[name='model_id']")
																.parent()
																.parent(".form-group")
																.removeClass("has-error")
																.find(".help-block")
																.hide();
															cb3();
														}
													);
													cb2();
												}
											});
										}
									);
									// 启动
									cb1();
								}
							});
						}
					);
				}
			});
		});

		// 选地址
		$("#txtAddress").click(function() {
			// 获取省份
			$.ajax({
				url: "/api/provList",
				type: "post",
				success: function(msg) {
					// 省份弹出层
					showModal(
						$("#modal-type-1-info"),
						{
							title: "省份",
							msg: msg,
							text: "ProvName",
							value: "Innerid",
							col: 12,
							width: "60%",
							float: "right"
						}, function(data1, cb1) {
							// 加载城市
							$.ajax({
								url: "/api/cityList",
								type: "post",
								data: {
									provid: data1.value
								},
								success: function(msg) {
									// 城市弹出层
									showModal(
										$("#modal-type-2-info"),
										{
											title: "城市",
											msg: msg,
											text: "CityName",
											value: "Innerid",
											col: 6,
											width: "40%",
											float: "right"
										}, function(data2, cb2) {
											$("#txtAddress").val("车源地：" + data1.text + "/" + data2.text);
											$("input[name='provid']").val(data1.value);
											$("input[name='cityid']").val(data2.value);
											$("#modal-type-2-info .closed").click();
											$("#modal-type-1-info .closed").click();
											$("input[name='cityid']")
												.parent()
												.parent(".form-group")
												.removeClass("has-error")
												.find(".help-block")
												.hide();
											cb2();
										}
									);
									// 启动
									cb1();
								}
							});
						}
					);
				}
			});
		});
		
		// 选上牌日期
		$("#txtRegisterDate").click(function() {
			if($("input[name='model_id']").val()) {
				// 上牌日期区间获取 
				$.ajax({
					url: "/api/carModelById?innerid=" + $("input[name='model_id']").val(),
					type: "get",
					success: function(msg) {
						// 生成结构体
						var arr = [];
						// 循环结构体
						for (var year = msg.Minregyear; year <= msg.Maxregyear; year++) {
							arr.push([
								{
									text: year + '年',
									value: year 
								}
							]);
						}
						// 省份弹出层
						showModal(
							$("#modal-type-1-info"),
							{
								title: "年份",
								msg: arr,
								text: "text",
								value: "value",
								col: 12,
								hidetitle: true,
								width: "75%",
								float: "right"
							}, function(data1, cb1) {
								arr = [];
								var bling = ['00','01','02','03','04','05','06','07','08','09'];
								for (var month = 1; month <= 12; month++) {
									if (month) {
										arr.push([
											{ text: month + "月", value: bling[month] ? bling[month] : month }
										]);
									}
								}
								// 加载月份
								showModal(
									$("#modal-type-2-info"),
									{
										title: "月份",
										msg: arr,
										text: "text",
										value: "value",
										col: 12,
										hidetitle: true,
										width: "50%",
										float: "right"
									}, function(data2, cb2) {
										$("#txtRegisterDate").val("上牌时间：" + data1.value + '-' + data2.value);
										$("input[name='register_date']").val(data1.value + '-' + data2.value);
										$("#modal-type-2-info .closed").click();
										$("#modal-type-1-info .closed").click();
										$("input[name='register_date']")
											.parent()
											.parent(".form-group")
											.removeClass("has-error")
											.find(".help-block")
											.hide();
										cb2();
									}
								);
								// 启动
								cb1();
							}
						);
					}
				});
			} else {
				alert("请先选择车型");
			}
		});
	}
</script>