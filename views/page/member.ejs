<div class="tabbable tabs-right">
    <form id="memberfrom"  action="/api/member" method="post" style="overflow-y: auto;padding: 0 10px;">
        <div class="tab-pane in active">
            <div class="form-group">
                <div id="divUpload" class="row" style="margin: 10px;">
                    <div id="imgUpload" class="col-lg-12 col-md-12 col-sm-12 col-xs-12" style="text-align: center;padding: 0;">
                        <i class="fa fa-picture-o" style="font-size: 90px;"></i>
                    </div>
<!--                     <div class="col-lg-7 col-md-7 col-sm-7 col-xs-7" style="text-align: left;padding: 8px 2px;">
                        请上传或拍摄一张图片作为自己的头像。
                    </div> -->
                </div>
                <span>
                    <input name="txtUpload" type="hidden" value="0">
                </span>
            </div>
            <div class="form-group" style="margin-bottom: 8px;">
                <span class="input-icon icon-left">
                    <input id="txtCustname" type="text" class="form-control" placeholder="昵称" style="padding-right: 36px;">
                    <input name="custname" type="hidden"/>
                    <i class="fa fa-user circular"></i>
                    <i id="qrcode" class="fa fa-qrcode circular" style="left: 100%;margin-left: -29px;font-size: 22px;top: 6.5px;"></i>
                </span>
            </div>
            <div class="form-group" style="margin-bottom: 8px;">
                <span class="input-icon icon-left">
                    <input id="txtSex" type="text" class="form-control" placeholder="性别" readonly="readonly">
                    <input name="sex" type="hidden"/>
                    <i class="fa fa-user circular"></i>
                </span>
            </div>
            <div class="form-group" style="margin-bottom: 8px;">
                <span class="input-icon icon-left">
                    <input id="txtBrithday" type="text" class="form-control date-picker" data-date-format="yyyy-mm-dd" placeholder="生日：年-月-日" readonly="readonly">
                    <input name="brithday" type="hidden"/>
                    <i class="fa fa-user circular"></i>
                </span>
            </div>
            <div class="form-group" style="margin-bottom: 8px;">
                <span class="input-icon icon-left">
                    <input id="txtAddress" type="text" class="form-control" placeholder="省/市" readonly="readonly">
                    <input name="provid" type="hidden"/>
                    <input name="cityid" type="hidden"/>
                    <i class="fa fa-user circular"></i>
                </span>
            </div>
            <div class="form-group" style="margin-bottom: 8px;">
                <span class="input-icon icon-left">
                    <input id="txtArea" type="text" class="form-control" placeholder="详细地址">
                    <input name="area" type="hidden"/>
                    <i class="fa fa-user circular"></i>
                </span>
            </div>
            <div class="form-group" style="margin-bottom: 8px;">
                <span class="input-icon icon-left">
                    <input id="txtEmail" type="text" class="form-control" placeholder="邮箱">
                    <input name="email" type="hidden"/>
                    <i class="fa fa-user circular"></i>
                </span>
            </div>
            <div class="form-group">
                <button type="submit" style="display:none;"></button>
            </div>
        </div>
    </form>
</div>
<input id="hidData" type="hidden" value="<%=JSON.stringify(data)%>"/>
<!--二维码页 -->
<div id="modal-qrcode-info" class="modal modal-message modal-info fade" style="z-index:1500" aria-hidden="true">
    <div class="modal-dialog" style="width: auto;">
        <div class="modal-content">
            <div class="modal-header">
                扫描二维码加好友
            </div>
            <div class="modal-body">
                <img src="<%=data.qnurl + data.QrCode%>" style="width: 150px;height: 150px;padding: 2% 5% 5% 5%;">
            </div>
        </div>
    </div>
</div>
<input class="modal-qrcode-info" type="hidden" data-toggle="modal" data-target="#modal-qrcode-info"/>
<script>
    /*
    * 初始化布局
    **/
    function init() {
        // 重定向
        if (sessionStorage.noMemberReturn == 'true') {
            location.href = "/open/home";
        }

        // 隐藏底部
        $("#widget-bottom").hide();

        // 窗口高度调节
        (function(height) {
            $("#page-body").height(height).css("padding", "5px 5px");
            $("#memberfrom").height(height);
        })(document.documentElement.clientHeight - 68);
        
        // 提交后台修改
        $("#btnOperation").click(function() {
            $("[type='submit']").click();
        });

        // 初始化数据绑定
        initData(
            $("#memberfrom"), 
            $("#hidData").val(), 
            [
                {
                    id: "#txtCustname", 
                    names: ["Custname"], 
                    number: 1,
                    prefix: "昵称：",
                    suffix: ""
                },
                {
                    id: "#txtSex", 
                    names: ["Sex"], 
                    number: 1,
                    filter: {
                        1: "男",
                        2: "女"
                    },
                    prefix: "性别：",
                    suffix: ""
                },
                {
                    id: "#txtBrithday", 
                    names: ["Brithday"], 
                    number: 1,
                    prefix: "生日：",
                    suffix: ""
                },
                {
                    id: "#txtAddress", 
                    names: ["ProvName", "CityName"], 
                    number: 2,
                    prefix: "省/市：",
                    suffix: ""      
                },
                {
                    id: "#txtArea", 
                    names: ["Area"], 
                    number: 1,
                    prefix: "详细地址：",
                    suffix: ""
                },
                {
                    id: "#txtEmail", 
                    names: ["Email"], 
                    number: 1,
                    prefix: "邮箱：",
                    suffix: ""
                }
            ],
            function(data) {
                $("#imgUpload").html((function ($img) {
                    // 计算缩放比例
                    var img = new Image(); 
                    img.src = data.Headportrait ? (data.qnurl + data.Headportrait) : (data.Wechat ? data.Wechat.Photo : "/img/tx.png"); 
                    img.onload = function() {
                        if (img.height > img.width) {
                            $img.height(($("#imgUpload").width() / 3 - 16) * 0.8)
                            .addClass("localIds")
                            .css({
                                "-webkit-box-shadow" : "3px 3px 7px #444",
                                "-moz-box-shadow" : "3px 3px 7px #444",
                                "box-shadow" : "3px 3px 7px #444"
                            })
                            .attr("src", img.src);
                        } else {
                            $img.width(($("#imgUpload").width() / 3 - 16))
                            .addClass("localIds")
                            .css({
                                "-webkit-box-shadow" : "3px 3px 7px #444",
                                "-moz-box-shadow" : "3px 3px 7px #444",
                                "box-shadow" : "3px 3px 7px #444"
                            })
                            .attr("src", img.src);
                        }
                    };
                    return $img;
                })($("<img></img>")));
            }
        );

        // 头像
        $("#imgUpload").click(function() {
            // 设置图片上传
            imgupload($(this), {
                max: 1,
                num: $("input[name='txtUpload']").val()
            }, function(data) {
                // 保存图片数量
                $("input[name='txtUpload']").val(data.num);
                // 图片个数是否合法
                if (data.num >= 3) {
                    $("input[name='txtUpload']")
                        .parent().parent()
                        .removeClass("has-error")
                        .find(".help-block")
                        .hide();
                }
            });
        });

        // 昵称
        $("#txtCustname").focus(function() {
            $(this).val("");
            $("input[name='custname']").val("");
        }).focusout(function() {
            if ($(this).val()) {
                $("input[name='custname']").val($(this).val());
                $(this).val("昵称：" + $(this).val());
            }
        });

        // 性别
        $("#txtSex").click(function() {
            showModal(
                $("#modal-type-1-info"),
                {
                    title: "请选择性别",
                    msg: {
                        display: [
                            { CodeName: '<a href="javascript:void(0);" class="btn btn-labeled btn-darkorange">男<i class="btn-label"></i></a>', CodeValue: "1" },
                            { CodeName: '<a href="javascript:void(0);" class="btn btn-labeled btn-palegreen">女<i class="btn-label"></i></a>', CodeValue: "2" }
                        ]
                    },
                    text: "CodeName",
                    value: "CodeValue",
                    col: 6,
                    isHideClose: true,
                    align: "center"
                }, function(data1, cb1) {
                    $("#txtSex").val("性别：" + data1.text);
                    $("input[name='sex']").val(data1.value);
                    $("#modal-type-1-info .closed").click();
                    cb1();
                }
            );
        });

        // 出生日期
        $("#txtBrithday").focusout(function() {
            var $this = this;
            setTimeout(function() {
                if ($($this).val() && /^(\d{4})-(\d{2})-(\d{2})$/.test($($this).val())) {
                    $("input[name='brithday']").val($($this).val())
                    $($this).val("生日：" + $($this).val());
                }
            }, 500);
        });

        // 选出生
        $("#txtBrithday").click(function() {
            // 生成结构体
            var arr = [];
            // 循环结构体
            for (var year = ((new Date).getFullYear() - 57); year <= ((new Date).getFullYear() - 17); year++) {
                arr.push([
                    {
                        text: year + '年',
                        value: year 
                    }
                ]);
            }
            // 省份弹出层
            showModal(
                $("#modal-type-1-info"),
                {
                    title: "年份",
                    msg: arr,
                    text: "text",
                    value: "value",
                    col: 12,
                    hidetitle: true,
                    width: "75%",
                    float: "right"
                }, function(data1, cb1) {
                    arr = [];
                    var bling = ['00','01','02','03','04','05','06','07','08','09'];
                    for (var month = 1; month <= 12; month++) {
                        if (month) {
                            arr.push([
                                { text: month + "月", value: bling[month] ? bling[month] : month }
                            ]);
                        }
                    }
                    // 加载月份
                    showModal(
                        $("#modal-type-2-info"),
                        {
                            title: "月份",
                            msg: arr,
                            text: "text",
                            value: "value",
                            col: 12,
                            hidetitle: true,
                            width: "50%",
                            float: "right"
                        }, function(data2, cb2) {
                            arr = [];
                            var bling = ['00','01','02','03','04','05','06','07','08','09'];
                            for (var month = 1; month <= 31; month++) {
                                if (month) {
                                    arr.push([
                                        { text: month + "日", value: bling[month] ? bling[month] : month }
                                    ]);
                                }
                            }
                            // 加载日
                            showModal(
                                $("#modal-type-3-info"),
                                {
                                    title: "天",
                                    msg: arr,
                                    text: "text",
                                    value: "value",
                                    col: 12,
                                    hidetitle: true,
                                    width: "25%",
                                    float: "right"
                                }, function(data3, cb3) {
                                    $("#txtBrithday").val("生日：" + data1.value + '-' + data2.value + '-' + data3.value);
                                    $("input[name='brithday']").val(data1.value + '-' + data2.value + '-' + data3.value);
                                    $("#modal-type-3-info .closed").click();
                                    $("#modal-type-2-info .closed").click();
                                    $("#modal-type-1-info .closed").click();
                                    $("input[name='brithday']")
                                        .parent()
                                        .parent(".form-group")
                                        .removeClass("has-error")
                                        .find(".help-block")
                                        .hide();
                                     cb3();
                                }
                            );
                            cb2();
                        }
                    );
                    // 启动
                    cb1();
                }
            );
        });

        // 选地址
        $("#txtAddress").click(function() {
            // 获取省份
            $.ajax({
                url: "/api/provList",
                type: "post",
                success: function(msg) {
                    // 省份弹出层
                    showModal(
                        $("#modal-type-1-info"),
                        {
                            title: "省份",
                            msg: msg,
                            text: "ProvName",
                            value: "Innerid",
                            col: 12,
                            width: "75%",
                            float: "right"
                        }, function(data1, cb1) {
                            // 加载城市
                            $.ajax({
                                url: "/api/cityList",
                                type: "post",
                                data: {
                                    provid: data1.value
                                },
                                success: function(msg) {
                                    // 城市弹出层
                                    showModal(
                                        $("#modal-type-2-info"),
                                        {
                                            title: "城市",
                                            msg: msg,
                                            text: "CityName",
                                            value: "Innerid",
                                            col: 6,
                                            width: "50%",
                                            float: "right"
                                        }, function(data2, cb2) {
                                            $("#txtAddress").val("省/市：" + data1.text + "/" + data2.text);
                                            $("input[name='provid']").val(data1.value);
                                            $("input[name='cityid']").val(data2.value);
                                            $("#modal-type-2-info .closed").click();
                                            $("#modal-type-1-info .closed").click();
                                            $("input[name='cityid']")
                                                .parent()
                                                .parent(".form-group")
                                                .removeClass("has-error")
                                                .find(".help-block")
                                                .hide();
                                            cb2();
                                        }
                                    );
                                    // 启动
                                    cb1();
                                }
                            });
                        }
                    );
                }
            });
        });

        // 详细地址
        $("#txtArea").focus(function() {
            $(this).val("");
            $("input[name='area']").val("");
        }).focusout(function() {
            if ($(this).val()) {
                $("input[name='area']").val($(this).val());
                $(this).val("详细地址：" + $(this).val());
            }
        });

        // 邮箱
        $("#txtEmail").focus(function() {
            $(this).val("");
            $("input[name='email']").val("");
        }).focusout(function() {
            if ($(this).val()) {
                $("input[name='email']").val($(this).val());
                $(this).val("邮箱：" + $(this).val());
            }
        });

        $("#qrcode").click(function() {
            $(".modal-qrcode-info").click();
        });
    }
</script>