<style>
    .extend-row {
        margin: 0;
        height: 45px;
    }
    .extend-btn-menu {
        padding: 8px 8px;
    }
    .extend-btn-menu .dropdown-toggle .fa {
        font-size: 23px; 
        color: #5db2ff;
        margin-top: 8px;
    }
    .extend-btn-menu ul li {
        border-bottom: 1px solid #eee;
        padding: 6px;
    }
    .extend-btn-menu ul li a {
        color: #737373;
    }
    .extend-btn-title {
        padding: 11px 10px 9px 10px;
    }
    .extend-btn-back {
        padding: 12px 0px;
    }
    .extend-glyphicon-arrow-left {
        white-space:nowrap;
        font-size: 20px; 
        color: #5db2ff;
        float: right;
    }
    #modal-add-info .modal-dialog {
        width: auto;
    }
</style>
<div class="row extend-row">
    <div class="col-lg-1 col-md-1 col-sm-1 col-xs-1 extend-btn-back" onclick="hideSearch()"> 
        <span class="fa fa-group extend-glyphicon-arrow-left"></span>  
    </div>
    <div id="lblTitle" class="col-lg-10 col-md-10 col-sm-10 col-xs-10 extend-btn-title text-left"> 
        <span class="widget-caption" style="font-size: 18px;"><%=title%></span>
    </div>
    <div id="btnMenu" class="col-lg-1 col-md-1 col-sm-1 col-xs-1 extend-btn-menu" style="text-align: left;padding: 9px 0px;box-shadow: none;"> 
        <div class="btn-group">
            <a class="dropdown-toggle" onclick="$(this).next('ul')[$(this).next('ul').css('display') == 'none' ? 'show' : 'hide']();">
                <span class="fa fa-plus"></span>
            </a>
            <ul class="dropdown-menu dropdown-menu-right">
                <li>
                    <a style="font-size: 16px;padding-left:5px;padding-left: 20px;" onclick="$('#btnAdd1').click();">
                        <img src="../img/friends.png" style="height: 22px;margin-top: -6px;"/>
                        <span style="padding-left: 6px;">添加好友</span>
                    </a>
                </li>
            </ul>
        </div>
    </div>             
</div>
<!-- 添加页 -->
<div id="modal-add-info" class="modal modal-message modal-info fade" style="display: none;z-index:1500" aria-hidden="true">
    <div class="modal-dialog" style="width: auto;">
        <div class="modal-content" style="padding-bottom: 20px;">
            <div class="modal-header">
                <div class="form-group" style="margin-bottom: 0;">
                    <span class="input-icon icon-right" style="width: 90%;">
                        <input id="txtCar" type="tel" class="form-control" placeholder="请输入至少4位手机号" style="font-size: 18px;border-right: 0;border-left: 0;border-top: 0;box-shadow: none;padding-right: 36px">
                        <i class="fa fa-search circular" style="font-size: 20px;box-shadow: none;color:rgb(87, 181, 227);margin-top: -2px;"></i>
                        <i class="fa fa-times circular" style="font-size: 24px;box-shadow: none;color:rgb(87, 181, 227);left: auto;right: 5px;display:none;"></i>
                    </span>
                </div>
            </div>
            <div class="modal-body">
                <div class="form-group t1" style="background-color: #ddd;padding: 10px;text-align: left!important;margin-bottom: 2px;">
                    <div class="row">
                        <div class="col-lg-3 col-md-3 col-sm-3 col-xs-3" style="padding:0;text-align: right!important;">
                            <img src="../img/qrcode.png" width="40px" style="border: 8px solid #57b5e3;margin-bottom: 4px;background-color: #57b5e3;">
                        </div>
                        <div id="btnQrcode" class="col-lg-9 col-md-9 col-sm-9 col-xs-9" style="padding: 0px 6px 5px 6px;text-align: left!important;">
                            <span>
                                <div class="item-time" style="font-size: larger;font-weight: bold;">
                                    扫一扫
                                </div>
                                <div class="item-time" style="font-size: small;color: #A3A3A3;">
                                    扫描二维码名片
                                </div>
                            </span>
                        </div>
                    </div>
                </div>
                <div class="form-group t2" style="background-color: #ddd;padding: 5px;text-align: left!important;margin-bottom: 0px;border-radius: 3px;margin-top: -5px;display:none;">
                    <div class="row">
                        <div class="col-lg-2 col-md-2 col-sm-2 col-xs-2" style="padding:0;text-align: left;padding-left: 15px;padding-top: 2px;">
                            <a class="btn btn-blue btn-lg icon-only white" href="javascript:void(0);" style="margin-top: -2px;">
                                <i class="fa fa-bullseye"></i>
                            </a>
                        </div>
                        <div class="col-lg-10 col-md-10 col-sm-10 col-xs-10" style="padding: 8px 5px 5px 6px;text-align: left!important;font-size: large;">
                            <span style="padding: 5px;"></span>
                        </div>
                    </div>
                </div>
                 <div class="form-group t3" style="padding: 0px 8px;text-align: left!important;margin-bottom: 0px;border-radius: 3px;margin-top: -5px;overflow-y: auto;overflow-x: hidden;">
                </div>
            </div>
        </div>
    </div>
</div>
<!-- 详情页 -->
<div id="modal-friend-info" class="modal modal-message modal-info fade" style="display: none;z-index:1500" aria-hidden="true">
    <div class="modal-dialog" style="width: auto;">
        <div class="modal-content">
            <div class="modal-header" style="font-size: 28px;">
                <a>
                    <img height="80" width="80" class="img-polaroid" style="border: 1px solid #ccc;border-radius: 1px;">
                </a>
            </div>
            <div class="modal-body">
                <span style="font-size: 18px;"></span>
                <br/>
                <textarea id="txtRemark" class="form-control" rows="3" style="margin-top: 10px;" placeholder="自我说明"></textarea>
            </div>
            <div class="modal-footer" style="margin: 15px 0 20px;">
                <button type="button" class="btn btn-info btn-lg" style="width: 100%;">关注</button>
            </div>
        </div>
    </div>
</div>
<input id="btnAdd1" type="hidden" data-toggle="modal" data-target="#modal-add-info"/>
<script>
    $(function() {
        // 默认不自动打开好友窗
        var isOpen = false;
        // 显示查询状态
        $("#txtCar").click(function() {
            // 清空内容
            $(this).val("");
            // 隐藏列表
            $("#modal-add-info .t3, #modal-add-info .t2").hide();
            // 显示查看页面
            $("#modal-add-info .modal-dialog")
            .css("margin", 0)
            .find(".modal-body")
            .css("height", document.documentElement.clientHeight - 90)
            .find(".t1")
            .hide()
            .parent()
            .parent()
            .find(".modal-header")
            .find(".fa-search")
            .hide()
            .parent()
            .find(".fa-times")
            .show();
        }).keyup(function() {
            // 控制显示搜索
            $("#modal-add-info .t2")[
                $(this).val().length >= 4 ? 'show' : 'hide'
            ]()
            .find("span")
            .text("搜索：" + $(this).val());
        });
        // 取消查询状态
        $("#modal-add-info .fa-times").click(function() {
            // 清空内容
            $("#txtCar").val("");
            // 隐藏内容
            $("#modal-add-info .t3, #modal-add-info .t2").hide();
            // 隐藏查看页面
            $("#modal-add-info .modal-dialog")
            .css("margin", 10)
            .find(".modal-body")
            .css("height", "100%")
            .find(".t1")
            .show()
            .parent()
            .parent()
            .find(".modal-header")
            .find(".fa-search")
            .show()
            .parent()
            .find(".fa-times")
            .hide();
        });
        // 执行查询
        $("#modal-add-info .t2").click(function() {
            $(this).hide();
            $("#modal-add-info .t3")
                .height($("#page-body").height() + 50)
                .show()
                .html('');
            // 取数据库中的会员列表
            $.ajax({
                url: "/api/custPageList",
                type: "get",
                data: {
                    mobile: $("#txtCar").val()
                },
                success: function(msg) {
                    //
                    if (msg && msg.data.length) {
                        // 循环显示会员
                        for (var o in msg.data) {
                            // 不能加自己
                            if(msg.data[o].Innerid != msg.id) {
                                $("#modal-add-info .t3").append(
                                    $("<div></div>")
                                    .addClass("row")
                                    .css({
                                        "margin-bottom": "10px",
                                        "margin-top": "10px"
                                    })
                                    .attr("innerid", msg.data[o].Innerid)
                                    .attr("custname", msg.data[o].Custname)
                                    .attr("headportrait", msg.data[o].Headportrait || msg.data[o].Photo)
                                    .attr("isFriends", msg.data[o].IsFriends)
                                    .attr("data-toggle", "modal")
                                    .attr("data-target", "#modal-friend-info")
                                    .append(
                                        $("<div></div>")
                                        .addClass("col-lg-2 col-md-2 col-sm-2 col-xs-2")
                                        .append(
                                            $("<img></img>")
                                            .prop("src", msg.data[o].Headportrait || msg.data[o].Photo)
                                            .css({
                                                "width": "40px",
                                                "height": "38px",
                                                "border": "1px solid #57b5e3",
                                                "background-color": "#57b5e3"
                                            })
                                        )
                                    )
                                    .append(
                                        $("<div></div>")
                                        .addClass("col-lg-10 col-md-10 col-sm-10 col-xs-10")
                                        .append(
                                            $("<span></span>")
                                            .append(
                                                $("<div></div>")
                                                .addClass("item-time")
                                                .css({
                                                    "font-size": "larger",
                                                    "font-weight": "bold"
                                                })
                                                .html(msg.data[o].Custname)
                                                .append(
                                                    !msg.data[o].IsFriends
                                                    ? $("<span></span>")
                                                    .addClass("label label-info graded")
                                                    .css({
                                                        "float": "right",
                                                        "font-size": "10px",
                                                        "margin-right": "3px",
                                                        "margin-top": "5px"
                                                    })
                                                    .html("加为好友")
                                                    : ""
                                                )
                                            )
                                            .append(
                                                $("<div></div>")
                                                .addClass("item-time")
                                                .css({
                                                    "font-size": "small",
                                                    "color": "#A3A3A3"
                                                })
                                                .html(msg.data[o].Mobile)
                                            ) 
                                        )
                                    )
                                    .click(function() {
                                        $("#modal-friend-info")
                                        .find("img")
                                        .attr("src", $(this).attr("headportrait"))
                                        .parent()
                                        .parent()
                                        .parent()
                                        .find("span")
                                        .html($(this).attr("custname"))
                                        .parent()
                                        .parent()
                                        .find("button")
                                        .attr("innerid", $(this).attr("innerid"))
                                        .click(function() {
                                            // 添加好友
                                            $.ajax({
                                                url: "/api/addRelationsApply",
                                                type: "post",
                                                data: {
                                                    innerid: $(this).attr("innerid"),
                                                    remark: $("#txtRemark").val()
                                                },
                                                success: function(msg) {
                                                    //
                                                    location.href = msg ? '/open/friends' : '/open/friends?showalert=warning&pagetype=friends';
                                                }
                                            });
                                        })[$(this).attr("isFriends") == 1 ? "hide" : "show"]();
                                    })
                                );
                            }
                            // 是否默认打开
                            if (isOpen) {
                                isOpen = false;
                                $("#modal-add-info .t3 .row").click();
                            }
                        }
                    } else {
                       $("#modal-add-info .t3").html("<div style='font-size: 20px;text-align: center;'>您所查找的用户不存在</div>"); 
                    }
                }
            });
        });
        // 微信二维码调用
        $("#btnQrcode").click(function() {
            // 调用微信二维码功能
            wx.scanQRCode({
                // 默认为0，扫描结果由微信处理，1则直接返回扫描结果
                needResult: 1, 
                // 可以指定扫二维码还是一维码，默认二者都有
                scanType: ["qrCode"],
                // 返回二维码结果
                success: function (res) {
                    // 查找好友
                    $("#txtCar").click().val(res.resultStr);
                    $("#modal-add-info .t2").click();
                    isOpen = true;
                }
            });
        });
    });
</script>