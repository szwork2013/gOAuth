<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>玖伍淘车</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="HandheldFriendly" content="True" />
    <meta name="MobileOptimized" content="640" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta http-equiv="cleartype" content="on" />
    <meta content="telephone =no" name="format-detection" />
    <meta name="screen-orientation" content="portrait">
    <meta name="x5-orientation" content="portrait">
    <meta name="viewport" id="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <link rel="shortcut icon" type="image/x-icon" href="../img/logo.ico" media="screen" />
    <%- include('./layout_loadCss', pageJson) -%>
    <script src="../js/jquery.min.js"></script>
    <script src="../js/autopx.js"></script>
    <script src="../js/bootstrap.min.js"></script>
    <!-- 验证 -->
    <script src="../js/validator.js"></script>
    <!-- 微信 -->
    <script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
</head>
<body>
    <div class="loading-container">
        <div class="loader"></div>
    </div>
    <div id="floating" style="height: 53px;min-width: 100%;position: absolute;z-index: 10;text-align: center;padding: 18px;background-color: rgba(255,255,255,0.7);border-bottom: 3px solid #5db2ff;display:none;">
        <span style="color: #5db2ff;font-size: larger;font-weight: 700;">请完善认证信息</span>
    </div>
    <div class="page-body" style="padding: 0px;overflow: hidden;">
        <div class="row" style="margin: 0;height: 100%;">
            <div class="col-lg-12 col-sm-12 col-xs-12" style="padding: 0;color: #737373;height: 100%;">
                <div class="widget" style="margin:0;height: 100%;">
                    <div class="widget-header bordered-bottom bordered-blue" style="padding: 0;">
                        <%- include(headerPath, pageJson) -%>
                    </div>
                    <div id="page-body" class="widget-body" style="background-color: #fff;padding: 5px;width: 100%;<% if (pagePath == '../page/about') { %>overflow-y: auto; <% } else { %>overflow-y: hidden;<% } %>" >
                        <%- include(pagePath, pageJson) -%>
                    </div>
                    <%- include('./layout_menu', pageJson) -%>
                </div>
            </div>
        </div>
    </div>
    <%- include('./layout_alert', pageJson) -%>
    <script>
        //是不是微信
        (function() {
            if (!navigator.userAgent.toLowerCase().match(/MicroMessenger/i)) {
                // location.href = '/html/yqtsym.html';
            }
        })();

        function setQueStr(url, ref, value) {
            var str = "";
            if (url.indexOf('?') != -1)
                str = url.substr(url.indexOf('?') + 1);
            else
                return url + "?" + ref + "=" + value;
            var returnurl = "";
            var setparam = "";
            var arr;
            var modify = "0";

            if (str.indexOf('&') != -1) {
                arr = str.split('&');

                for (i in arr) {
                    if (arr[i].split('=')[0] == ref) {
                        setparam = value;
                        modify = "1";
                    }
                    else {
                        setparam = arr[i].split('=')[1];
                    }
                    returnurl = returnurl + arr[i].split('=')[0] + "=" + setparam + "&";
                }

                returnurl = returnurl.substr(0, returnurl.length - 1);

                if (modify == "0")
                    if (returnurl == str)
                        returnurl = returnurl + "&" + ref + "=" + value;
            }
            else {
                if (str.indexOf('=') != -1) {
                    arr = str.split('=');

                    if (arr[0] == ref) {
                        setparam = value;
                        modify = "1";
                    }
                    else {
                        setparam = arr[1];
                    }
                    returnurl = arr[0] + "=" + setparam;
                    if (modify == "0")
                        if (returnurl == str)
                            returnurl = returnurl + "&" + ref + "=" + value;
                }
                else
                    returnurl = ref + "=" + value;
            }
            return url.substr(0, url.indexOf('?')) + "?" + returnurl;
        }

        function delQueStr(url, ref) {
            var str = "";

            if (url.indexOf('?') != -1)
                str = url.substr(url.indexOf('?') + 1);
            else
                return url;
            var arr = "";
            var returnurl = "";
            var setparam = "";
            if (str.indexOf('&') != -1) {
                arr = str.split('&');
                for (i in arr) {
                    if (arr[i].split('=')[0] != ref) {
                        returnurl = returnurl + arr[i].split('=')[0] + "=" + arr[i].split('=')[1] + "&";
                    }
                }
                return url.substr(0, url.indexOf('?')) + "?" + returnurl.substr(0, returnurl.length - 1);
            }
            else {
                arr = str.split('=');
                if (arr[0] == ref)
                    return url.substr(0, url.indexOf('?'));
                else
                    return url;
            }
        }

        /*
        * 图片上传
        * max：最大的数量
        * num: 当前的数量
        */
        function imgupload($imgs, options, callback) {
            // 调用微信本地上传接口
            wx.chooseImage({
                count: options.max - options.num,
                sizeType: ['original', 'compressed'],
                sourceType: ['album', 'camera'],
                success: function (res) {
                    // 图片对象
                    var arrsserver = [];
                    // 获取本地图片数组
                    (function(imgs, i) {
                        // 图片是否存在1张或多张
                        if (imgs.length) {
                            // 自身递归
                            var fun = arguments.callee;
                            // 上传到微信
                            wx.uploadImage({
                                localId: imgs[i],
                                isShowProgressTips: 1,
                                success: function (res) {
                                    // 保存微信素材id
                                    arrsserver.push(res.serverId);
                                    // 图片控件是否存在
                                    if ($imgs.size()) {
                                        // 是否只有一张图片
                                        if (options.max != 1) {
                                            // 加图片
                                            $imgs.append(
                                                $("<div></div>")
                                                .prop("id", res.serverId)
                                                .prop("onclick", "delImg(\'" + res.serverId + "\', \'\')")
                                                .addClass("col-lg-4 col-md-4 col-sm-4 col-xs-4")
                                                .css({
                                                    "text-align": "center",
                                                    "padding": "5px 5px 10px 5px",
                                                    "background-color": "#fff",
                                                    "border": "1px solid #d5d5d5",
                                                    "width": ($imgs.width() / 3) + "px",
                                                    "height": ($imgs.width() / 3) * 0.8 + "px",
                                                    "line-height": ($imgs.width() / 3 * 0.8 - 15) + "px"
                                                }).append((function ($img) {
                                                    // 计算缩放比例
                                                    var img = new Image(); 
                                                    img.src = imgs[i]; 
                                                    img.onload = function() {
                                                        if (img.height > img.width) {
                                                            $img.css("max-height", ($("#carsupload").width() / 3 - 16) * 0.8)
                                                            .addClass("animated flipInX localIds")
                                                            .css({
                                                                "-webkit-box-shadow" : "3px 3px 7px #444",
                                                                "-moz-box-shadow" : "3px 3px 7px #444",
                                                                "box-shadow" : "3px 3px 7px #444"
                                                            })
                                                            .prop("src", img.src);
                                                        } else {
                                                            $img.css("max-width", ($("#carsupload").width() / 3 - 16))
                                                            .addClass("animated flipInX localIds")
                                                            .css({
                                                                "-webkit-box-shadow" : "3px 3px 7px #444",
                                                                "-moz-box-shadow" : "3px 3px 7px #444",
                                                                "box-shadow" : "3px 3px 7px #444"
                                                            })
                                                            .prop("src", img.src);
                                                        }
                                                    };
                                                    return $img;
                                                })($("<img></img>"))).append(
                                                    $("<input></input>")
                                                    .prop("type", "hidden")
                                                    .prop("name", "img" + i)
                                                    .val(res.serverId)
                                                )
                                            );
                                        } else {
                                            $imgs.html((function ($img) {
                                                // 计算缩放比例
                                                var img = new Image(); 
                                                img.src = imgs[i]; 
                                                img.onload = function() {
                                                    if (img.height > img.width) {
                                                        $img.height(($("#imgUpload").width() / 3 - 16) * 0.8)
                                                        .addClass("animated flipInX localIds")
                                                        .css({
                                                            "-webkit-box-shadow" : "3px 3px 7px #444",
                                                            "-moz-box-shadow" : "3px 3px 7px #444",
                                                            "box-shadow" : "3px 3px 7px #444"
                                                        })
                                                        .attr("src", img.src);
                                                    } else {
                                                        $img.width(($("#imgUpload").width() / 3 - 16))
                                                        .addClass("animated flipInX localIds")
                                                        .css({
                                                            "-webkit-box-shadow" : "3px 3px 7px #444",
                                                            "-moz-box-shadow" : "3px 3px 7px #444",
                                                            "box-shadow" : "3px 3px 7px #444"
                                                        })
                                                        .attr("src", img.src);
                                                    }
                                                };
                                                return $img;
                                            })($("<img></img>"))).append(
                                                $("<input/>")
                                                .prop("type", "hidden")
                                                .prop("name", "img" + i)
                                                .val(res.serverId)
                                            );
                                        }
                                    }
                                    // 递归存入上传id
                                    (function(i) {
                                        if (imgs[i]) {
                                            fun(imgs, i);
                                        } else {
                                            callback({
                                                imgs: arrsserver
                                            });
                                        }
                                    })(++i);
                                }
                            });
                        }
                    })(res.localIds, 0);
                }
            });
        }

        // 是否是微信打开
        $.ajax({
            url: "/api/wechatCertification",
            type: "get",
            data: {
                url : location.href
            },
            success: function (data) {
                if (wx) {
                    // 配置
                    wx.config({
                        //必须传入，不然没办法调未正式发布的jsapi
                        beta: true,
                        debug: false,
                        appId: "<%= appId%>",
                        timestamp: data.timestamp,
                        nonceStr: data.nonceStr,
                        signature: data.signature,
                        jsApiList: [
                            "chooseImage",
                            "uploadImage",
                            "onMenuShareTimeline",
                            "hideMenuItems",
                            "hideOptionMenu",
                            "scanQRCode",
                            "startRecord",
                            "translateVoice",
                            "stopRecord",
                            "downloadImage"
                        ]
                    });
                    //分享接口函数
                    wx.ready(function() {
                        // 认证
                        if (typeof shareFun != 'undefined' && shareFun instanceof Function) { 
                            shareFun(); 
                        } else {
                            wx.hideOptionMenu(); 
                        }
                    });
                } else {
                    alert("请使用微信打开");
                }
            }
        });

        /*
        * 初始化赋值
        **/
        function initData($id, data, txtArr, cb) {
            if (data) {
                data = (typeof data == "string") ? JSON.parse(data) : data;
                for (var n in data) {
                    // name 辅助器
                    $id.find("input[name='" + n.toLocaleLowerCase() + "'], textarea[name='" + n + "']").val(data[n] ? (function() {
                        if (typeof data[n] == "object") {
                            return JSON.stringify(data[n]);
                        }
                        return data[n];
                    }) : "");
                    $id.find("span[name='" + n.toLocaleLowerCase() + "']").text(data[n] ? (function() {
                        if (typeof data[n] == "object") {
                            return JSON.stringify(data[n]);
                        }
                        return data[n];
                    }) : "");
                    // 文本赋值
                    for (var i in txtArr) {
                       (function(a) {
                            if (a != -1) {
                                txtArr[i].number --;
                                txtArr[i].names[a] = data[n] ? data[n] : "";
                                if(!txtArr[i].number) {
                                    if (txtArr[i].names.join("") != "") {
                                        $(txtArr[i].id)[$(txtArr[i].id)[0].localName == 'input' ? 'val' : 'text'](
                                            txtArr[i].prefix + (function(obj){
                                                return obj.filter ? (obj.filter[obj.names.join("/")] || '') : obj.names.join("/");
                                            })(txtArr[i]) + txtArr[i].suffix
                                        );
                                    }
                                }
                            }
                        })(txtArr[i].names.indexOf(n));
                    }
                }
                cb(data);
            }
        }

        /**
         * 月(M)、日(d)、小时(h)、分(m)、秒(s)、季度(q) 可以用 1-2 个占位符， 
         * 年(y)可以用 1-4 个占位符，毫秒(S)只能用 1 个占位符(是 1-3 位的数字) 
         * 例子： 
         *    (new Date()).format("yyyy-MM-dd hh:mm:ss.S") ==> 2006-07-02 08:09:04.423 
         *    (new Date()).format("yyyy-M-d h:m:s.S")      ==> 2006-7-2 8:9:4.18 
         * 
         * @param {String} fmt 日期格式字符串
         */
        Date.prototype.format = function (fmt) {
            var o = {
                //月份 
                "M+": this.getMonth() + 1,      
                //日 
                "d+": this.getDate(),
                //小时 
                "h+": this.getHours(),      
                //分 
                "m+": this.getMinutes(),        
                //秒 
                "s+": this.getSeconds(),            
                //季度 
                "q+": Math.floor((this.getMonth() + 3) / 3), 
                //毫秒 
                "S": this.getMilliseconds()
            };
            if (/(y+)/.test(fmt)) {
                fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
            }
            for (var k in o) {
                if (new RegExp("(" + k + ")").test(fmt)) {
                    fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
                }
            }
            return fmt;
        };

        $(function() {
            // 菜单定位
            $(".page-body").height(document.documentElement.clientHeight);
            $("#page-body").height(document.documentElement.clientHeight - (96 * $("#page-body").width() / 640) - 55);
            // 初始化
            if (typeof init != 'undefined' && init instanceof Function) init();
            // 加载结束
            $(".loading-container").addClass("loading-inactive");
        });
    </script>
</body>
</html>