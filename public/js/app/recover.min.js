/**
* 初始化入口
**/
function init() {
	// 禁用滚动条
	$(".app").css("overflow", "hidden");
	// 显示或隐藏密码
	$(".ico_eyes").click(function() {
		// 是否显示密码
		if ($(this).parent().hasClass("app_active")) {
			$(this).parent()
				.removeClass("app_active")
				.find(".txt_password")
				.prop("type", "password");
		} else {
			$(this).parent()
				.addClass("app_active")
				.find(".txt_password")
				.prop("type", "text");
		}
	});
	// timer变量，控制时间
	var interValObj, 
		// 间隔函数，1秒执行
    	count = 60, 
    	// 当前剩余秒数
    	curCount,
    	// 倒计时
    	setRemainTime = function () {
            if (curCount == 0) {
            	//停止计时器            
                window.clearInterval(interValObj);
                $(".btn_vcode").addClass("btn_active");
                $("input[name='vcode']").prop("placeholder", "您获取的验证码");
                $(".btn_vcode").text("重新发送验证码");
            } else {
                curCount--;
                $(".btn_vcode").text(curCount + "秒后可重发");
            }
    };
    // 发送验证码
	$(".btn_vcode").click(function() {
		// 是否允许发送
		if ($(this).hasClass("btn_active")) {
			// 禁用发送按钮
			$(".btn_vcode").removeClass("btn_active");
			// 计时
			curCount = count;
        　　// 设置button效果，开始计时
            $(".btn_vcode").text(curCount + "秒后可重发");
            // 倒计时
            interValObj = window.setInterval(setRemainTime, 1000);
        　　// 向后台发送处理数据
        	$.ajax({
                url: "/api/sendVerification",
                type: "post",
                data: {
                    mobile: $("input[name='mobile']").val(),
                    utype: "3",
                    length: 6,
                    ttype: "1",
                    vtype: "1"
                },
                success: function (data) {
                    // 发送验证码是否成功
                    if (data.errcode) {
                    	$("body").css("overflow", "hidden");
						$(".app_alert .modal-title").html("对不起！");
						$(".app_alert .modal-body").html("发送验证码失败");
						$(".app_alert .confirm").hide();
						$("#btnGb").html("确定");
						$(".app_alert").addClass("warning").show();
                    }
                }
            });
        }
	});
	// 验证绑定
	$validators.init({
		mobile: {
			notEmpty: {
				message: '* 手机号码不能为空'
			},
            regular: {
                reg: /^(0|86|17951)?(13[0-9]|15[012356789]|17[678]|18[0-9]|14[57])[0-9]{8}$/,
                message: '* 手机号码必须合法且为11位数字'
            },
            callback: function(issuccess) {
            	// 是否验证成功
				$(".btn_vcode")[ issuccess ? "addClass" : "removeClass" ]("btn_active");
				// 验证手机号是否被使用
				if (issuccess) {
					// 后台去验证手机号是否存在
					$.ajax({
						url: "/api/checkByMobile",
						type: "post",
						data: {
							mobile: $("input[name='mobile']").val()
						},
						success: function(data) {
							// 显示验证结果
							if (!data.errcode) {
								$("input[name='mobile']").parent().addClass("err").find(".lbl_err").html("* 该手机号码不存在");
							}
						}
					});
				}
            }
		},
		password: {
			notEmpty: {
				message: '* 登录密码不能为空'
			},
			stringLength: {
				min: 6,
				max: 20,
				message: '* 登录密码长度只允许输入6到20位'
			},
            regular: {
                reg: /^\w{6,20}$/,
                message: '* 登录密码只能包含数字字母下划线'
            }
		},
		vcode: {
			notEmpty: {
				message: '* 验证码不能为空'
			},
            regular: {
                reg: /^[0-9]{6}$/,
                message: '* 验证码必须为6位数字'
            }
		}
	}, [
		"mobile"
	]);
	// 登录系统
	var isbool = true;
	$(".btn_recover").click(function() {
		// 验证触发
		if ($validators.start()) {
			// 是否准入
			if (isbool) {
				// 禁止准入
				isbool = false;
				// 调用注册
				$.ajax({
					url: "/api/recover",
					type: "post",
					data: {
						mobile: $("input[name='mobile']").val(),
						password: $("input[name='password']").val(),
						vcode: $("input[name='vcode']").val()
					},
					success: function(data) {
						// 允许准入
						isbool = true;
						// 判断返回
						switch(data.errcode) {
							// 成功
			                case 0:
			                	// 设置重置状态
			                	sessionStorage.isrecover = true;
			                	// 返回登录页
			                	location.href = "/open/login";
			                break;
			                // 该验证码无效
			                case 400:
		                    case 401:
			                    $("body").css("overflow", "hidden");
								$(".app_alert .modal-title").html("对不起！");
								$(".app_alert .modal-body").html("该验证码无效");
								$(".app_alert .confirm").hide();
								$("#btnGb").html("确定");
								$(".app_alert").addClass("warning").show();
		                    break;
		                    // 该手机号被冻结
		                    case 403:
			                    $("body").css("overflow", "hidden");
								$(".app_alert .modal-title").html("对不起！");
								$(".app_alert .modal-body").html("该手机号码不存在");
								$(".app_alert .confirm").hide();
								$("#btnGb").html("确定");
								$(".app_alert").addClass("warning").show();
		                    break;
		                   	// openid已绑定其他手机号
		                   	case 404:
		                   		$("body").css("overflow", "hidden");
								$(".app_alert .modal-title").html("警告！");
								$(".app_alert .modal-body").html("该手机号码已被冻结");
								$(".app_alert .confirm").hide();
								$("#btnGb").html("确定");
								$(".app_alert").addClass("warning").show();
		                   	break;
		                   	// 注册失败
		                   	case 405:
		                   		$("body").css("overflow", "hidden");
								$(".app_alert .modal-title").html("对不起！");
								$(".app_alert .modal-body").html("重置失败");
								$(".app_alert .confirm").hide();
								$("#btnGb").html("确定");
								$(".app_alert").addClass("error").show();
		                   	break;
		                   	// 服务器维护中
		                   	case 499:
		                   		$("body").css("overflow", "hidden");
								$(".app_alert .modal-title").html("摊上大事啦！");
								$(".app_alert .modal-body").html("服务器维护中...");
								$(".app_alert .confirm").hide();
								$("#btnGb").html("确定");
								$(".app_alert").addClass("error").show();
		                   	break;
		                }
					}
				});
			}
		}
	});
}