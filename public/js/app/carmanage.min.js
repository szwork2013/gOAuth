// 分页页码
var pageindex = 1, pagebool = true;

/*
* 编辑
**/
function carEdit(id) {
    $.ajax({
        url: "/api/carViewById",
        type: "post",
        data: {
            id: id
        },
        success: function(msg) {
            // 存储编辑内容
            sessionStorage.carEditData = JSON.stringify(msg);
            // 跳转编辑页
            location.href = '/open/carsUpload';
        }
    });
}

/**
* 打开详情页
***/
function cardetail(carid) {
	window.location.href = "/open/cardetail?carid=" + carid + "&isfriend=-1&custid=" + $("#custid").val();
}

/**
* 加载列表
***/
function loadingSearch(index) {
	// 换页
    if (index) {
    	$(".app_bottom").html("");
    	pageindex = index;
    	pagebool = true;
    } else {
    	pageindex++;
    }
    // 是否翻页
    if (pagebool) {
    	// 加载动画
    	$(".loading-container").removeClass("loading-inactive");
        // 加载数据
        $.ajax({
            url: "&brandid=" + $("input[name='brand']").val() + "&pageindex=" + pageindex,
            type: "get",
            success: function(msg) {
            	// 是否还有车
            	if (msg.cars.length) {
            		// 循环数据
					for(var i = 0; i < msg.cars.length; i++) {
					}
				} else {
					pagebool = false;
				}
				// 加载结束
				$(".loading-container").addClass("loading-inactive");
            }
        });
	}
}

/**
* 确认方法
***/
function confirmFun() {
	// 调用中介上的脚本
	if ($("input[name='mediation']").attr("innerid")) {
		$("input[name='mediation']").click();
	} else {
		$("body").css("overflow", "hidden");
		$(".app_alert .modal-title").html("对不起！");
		$(".app_alert .modal-body").html("操作异常！");
		$("#btnGb").html("确定");
		$(".app_alert").addClass("warning").show();
	}
}

/**
* 加载入口
***/
function init() {
	// 页面布局定位
	$(".app_bottom").height(document.documentElement.clientHeight - 268);
	// 设置筛选
	$("input[name='brand']").val(sessionStorage.BrandName_value || "");
	$(".app_body .body_left").find("div").html(sessionStorage.BrandName_text || "车辆品牌");
	if (sessionStorage.isfill == "true" || sessionStorage.BrandName_value == "") {
		sessionStorage.isfill = "false";
		// 执行搜索
		location.href = setQueStr(location.href, "brandid", sessionStorage.BrandName_value);
		sessionStorage.BrandName_value = "-";
	}
	// 隐藏菜单
	$(".app_menu_mask").click(function() {
		$(".bottom_menu, .app_menu_mask").hide();
	});
	// 显示菜单
	$(".content_bottom_img").click(function() {
		$(".app_menu_mask").click().show();
		// 绑定id
		(function ($this, id) {
			$this.find(".menu_edit").attr("innerid", id);
			$this.find(".menu_delete").attr("innerid", id);
			$this.find(".menu_settle").attr("innerid", id);
		})($(".bottom_menu").css("top", $(this).offset().top - 114).show(), $(this).attr("innerid"));
	});
	// 绑定编辑事件
	$(".bottom_menu").find(".menu_edit").click(function() {
		carEdit($(this).attr("innerid"));
	});
	// 绑定删除事件
	$(".bottom_menu").find(".menu_delete").click(function() {
		$("body").css("overflow", "hidden");
		$(".app_alert .modal-title").html("确认删除？");
		$("#btnGb").html("取消");
		$(".app_alert .modal-body").html("<textarea rows='5' placeholder='删除原因：可填，限100个字符' maxlength='100'></textarea>");
		$("input[name='mediation']").attr("innerid", $(this).attr("innerid")).click(function() {
			// 提交删除
			$.ajax({
				url: "/api/deleteCar",
				type: "post",
				data: {
					innerid: $(this).attr("innerid"),
					dealdesc: $(".app_alert .modal-body textarea").val()
				},
				success: function(msg) {
					// 清删除id
					$("input[name='mediation']").removeAttr("innerid");
					$(".app_alert .modal-body").html("");
					// 是否删除成功
					if (msg.errcode) {
						$("body").css("overflow", "hidden");
						$(".app_alert .modal-title").html("对不起！");
						$(".app_alert .modal-body").html("删除失败!");
						$(".app_alert .confirm").hide();
						$("#btnGb").html("确定");
						$(".app_alert").addClass("warning").show();
					} else {
						location.href = "/open/cars";
					}
				}
			});
		});
		$(".app_alert .confirm").show();
		$(".app_alert").show();
	});
	// 绑定结案事件
	$(".bottom_menu").find(".menu_settle").click(function() {
		$("body").css("overflow", "hidden");
		$(".app_alert .modal-title").html("确认结案？");
		$("#btnGb").html("取消");
		$(".app_alert .modal-body").html("<input type='text' placeholder='交易金额：单位 万元'><textarea rows='5' placeholder='交易备注：可填，限100个字符' maxlength='100'></textarea>");
		$("input[name='mediation']").attr("innerid", $(this).attr("innerid")).click(function() {
			// 提交结案
			$.ajax({
				url: "/api/dealCar",
				type: "post",
				data: {
					innerid: $(this).attr("innerid"),
					dealprice: $(".app_alert .modal-body input").val(),
					dealdesc: $(".app_alert .modal-body textarea").val()
				},
				success: function(msg) {
					// 清删除id
					$("input[name='mediation']").removeAttr("innerid");
					$(".app_alert .modal-body").html("");
					// 是否结案成功
					if (msg.errcode) {
						$("body").css("overflow", "hidden");
						$(".app_alert .modal-title").html("对不起！");
						$(".app_alert .modal-body").html("结案失败!");
						$(".app_alert .confirm").hide();
						$("#btnGb").html("确定");
						$(".app_alert").addClass("warning").show();
					} else {
						location.href = "/open/cars";
					}
				}
			});
		});
		$(".app_alert .confirm").show();
		$(".app_alert").show();
	});
	// 单选按钮组件
	$(".header_position div[class^='header_btn_']").click(function() {
		// 取消选择
		$(".header_position div[class^='header_btn_']").map(function(i, n) {
			$(n).removeClass("active");
		});
		// 设置选择
		$(this).addClass("active");
	});
	// 选择品牌车系
	$(".app_body .body_left").click(function() {
		location.href = "/open/carBrand?isbrand=true&type=1";
	});
	// 去发朋友圈
	$(".app_bottom .li_bottom_middle").click(function() {
		location.href =  "/open/release?id=" + $(this).attr("innerid");
	});
	// 弹出提示
	switch(getQueryString('pagetype')) {
        case 'cars':
            // 缓存状态
            sessionStorage.noCarReturn = true;
            $("body").css("overflow", "hidden");
			$(".app_alert .modal-title").html("恭喜您！");
			$("#btnGb").html("确定");
			$(".app_alert .confirm").hide();
			$(".app_alert .modal-body").html("添加成功！");
			$(".app_alert").addClass("success").show();
        break;
        case 'cars_edit':
            // 缓存状态
            sessionStorage.noCarReturn = true;
            $("body").css("overflow", "hidden");
			$(".app_alert .modal-title").html("恭喜您！");
			$("#btnGb").html("确定");
			$(".app_alert .confirm").hide();
			$(".app_alert .modal-body").html("编辑成功！");
			$(".app_alert").addClass("success").show();
        break;
	}
	// 缓存链接
	sessionStorage.href = location.href;
}