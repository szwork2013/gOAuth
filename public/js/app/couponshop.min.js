/**
* 加载入口
***/
function init() {
	// 创建分页搜索对象
	var searchFun = loadingSearch({
		// 列表对象
		body: $(".bottom_body_data"),
		// 数据源地址
		urlFun: function (pageindex) {
			return (function () {
				return $("#type").val() == "1" ? "/api/mallCouponPageList" : "/api/mallShopPageList";
			})() + "?title=" + $(".input_search").val() + "&cardTypes=" + $("#cardtype").val() + "&cityid=" + $("#cityid").val() + "&areaid=" + $("#areaid").val()  + "&shopid=" + $("#shopid").val() + "&pageindex=" + pageindex;
		},
		// 请求类型
		type: "get",
		// 数据源名称
		dataName: "list",
		// 无数据显示图片
		htmlFun: function (msg) {
			return $("<div></div>").addClass("null_class")
			.append(
				$("<img></img>").attr("src", "../img/app/mallnull.jpg")
			)
			.append(
				$("<div></div>").addClass("null_class_title")
				.append(
					$("<span></span>").append(
						msg.type == 1 ? "您当前所选的地区没有找到此类商品<br/>试试搜索其他商品类型吧~" : "您当前所选地区没有找到满足条件的商户<br/>试试搜索其他商品类型吧~"
					)
				)
			);
		},
		// 结果控制方法
		nullFun: function (msg) {
		},
		// 行html生成
		appendFun: function(msg, row, cb) {
			// 加到页面
			cb(
				$("<a></a>").attr("href", msg.type == 1 ? (row.ProductUrl || '#') : ('/open/shopViewById?id=' + row.Innerid))
				.append(
					$("<div></div>").addClass("body_li")
					.append(
						$("<div></div>").addClass("body_li_frame")
						.append(
							$("<img></img>").addClass("li_frame_img").attr("src", msg.qnUrl + (msg.type == 1 ? row.Logourl : row.Headportrait))
						)
						.append(
							$("<div></div>").addClass("li_frame_text")
							.append(
								$("<span></span>").addClass("frame_text_title").html(msg.type == 1 ? row.Title : row.Shopname)
							)
							.append(
								$("<span></span>").addClass("frame_text_note").html(msg.type == 1 ? row.ShopArea : row.Area + "/" + msg.type == 1 ? row.Shopname : row.Address)
							)
							.append(
								msg.type == 1
								? $("<span></span>").addClass("frame_text_money")
								.append(
									$("<span></span>").addClass("frame_text_money_fh").html("¥")
								)
								.append(
									$("<span></span>").html(row.BuyPrice)
								)
								.append(
									$("<span></span>").addClass("frame_text_money_yj")
									.append(
										$("<span></span>").addClass("frame_text_money_yj_fh").html("¥")
									)
									.append(
										row.Amount
									)
								)
								: (function ($div) {
									if (row.CardTypeNames) {
										var arrJuan = row.CardTypeNames.split(",");
										for (var j=0; j < arrJuan.length; j++) {
											$div.append($("<div></div>").addClass("text_lable").html(arrJuan[j] || "未知"));
										}
									}
									return $div;
								})(
									$("<div></div>").addClass("frame_text_lable")
								)
							)
							.append(
								$("<span></span>").addClass("frame_text_money_yj_yssl").html("已售 " + (row.SoldedNum || "0"))
							)
						)
					)
				)
			);
		},
		// 复位
		initQuery: function () {
			$("#app_bottom_body").css("top", 0);
		}
	});
	// 页面布局定位
	$(".app_bottom").height(document.documentElement.clientHeight - 127);
	$(".app_bottom .app_bottom_body").height($(".app_bottom").height() - 139);
	$(".app_screening").height($(".app_bottom").height() - 139);
	// 自定义滚动条
	$scroll.beforeFun = function() {
		if (!($(".app")[0].scrollTop >= 199 && parseInt($scroll._id.css("top")) <= 0)) return true;
		return false;
	};
	$scroll.init("#app_bottom_body", function() {
		searchFun(0);
	});
	// 搜索框状态
	$(".app_bottom .header_top_search").click(function() {
		$(this).addClass("active");
		$(this).find(".input_search").focus();
	}).find(".input_search").blur(function() {
		(function ($this) {
			if (!$this.find(".input_search").val()) {
				$this.removeClass("active");
			}
		})($(".app_bottom .header_top_search"));
	}).keyup(function() {
		sessionStorage.title = $(this).val();
		searchFun(1);
	});
	// 筛选栏状态
	$(".app_bottom_header .header_bottom_left").click(function() {
		if ($(this).find(".fa").hasClass("fa-caret-down")) {
			$(".app_bottom_header div[class^='header_bottom_']").css("color", "#666").find(".header_bottom_text").css("color", "#666");
			$(".app_bottom_header div[class^='header_bottom_']").find(".fa").removeClass("fa-caret-up").addClass("fa-caret-down");
			$(this).css("color", "#ff6700").find(".header_bottom_text").css("color", "#ff6700");
			$(this).find(".fa").removeClass("fa-caret-down").addClass("fa-caret-up");
			// 控制显示筛选
			$(".app_screening").show();
			$(".app_screening .screening_dq").hide();
			$(".app_screening .screening_ul").show();
		} else {
			$(".app_bottom_header div[class^='header_bottom_']").css("color", "#666").find(".header_bottom_text").css("color", "#666");
			$(".app_bottom_header div[class^='header_bottom_']").find(".fa").removeClass("fa-caret-up").addClass("fa-caret-down");
			$(".app_screening").hide();
			$(".app_screening .screening_ul").hide();
			$(".app_screening .screening_dq").hide();
		}
	});
	// 筛选栏状态
	$(".app_bottom_header .header_bottom_right").click(function() {
		if ($(this).find(".fa").hasClass("fa-caret-down")) {
			$(".app_bottom_header div[class^='header_bottom_']").css("color", "#666").find(".header_bottom_text").css("color", "#666");
			$(".app_bottom_header div[class^='header_bottom_']").find(".fa").removeClass("fa-caret-up").addClass("fa-caret-down");
			$(this).css("color", "#ff6700").find(".header_bottom_text").css("color", "#ff6700");
			$(this).find(".fa").removeClass("fa-caret-down").addClass("fa-caret-up");
			// 控制显示筛选
			$(".app_screening").show();
			$(".app_screening .screening_ul").hide();
			$(".app_screening .screening_dq").show();
		} else {
			$(".app_bottom_header div[class^='header_bottom_']").css("color", "#666").find(".header_bottom_text").css("color", "#666");
			$(".app_bottom_header div[class^='header_bottom_']").find(".fa").removeClass("fa-caret-up").addClass("fa-caret-down");
			$(".app_screening").hide();
			$(".app_screening .screening_ul").hide();
			$(".app_screening .screening_dq").hide();
		}
	});
	// 搜索卡劵
	var arrTypes = [];
	$(".screening_ul_cd_btn").click(function() {
		$(".app_bottom_header div[class^='header_bottom_']").css("color", "#666").find(".header_bottom_text").css("color", "#666");
		$(".app_bottom_header div[class^='header_bottom_']").find(".fa").removeClass("fa-caret-up").addClass("fa-caret-down");
		$(".app_screening").hide();
		$(".app_screening .screening_ul").hide();
		$(".app_screening .screening_dq").hide();
	});
	$(".app_screening .screening_ul .screening_ul_li").click(function() {
		if ($("#type").val() == "1") {
			$("#cardtype").val($(this).attr("value"));
			$(".app_bottom_header .header_bottom_left span").html($(this).attr("text"));
			$(".app_bottom_header div[class^='header_bottom_']").css("color", "#666").find(".header_bottom_text").css("color", "#666");
			$(".app_bottom_header div[class^='header_bottom_']").find(".fa").removeClass("fa-caret-up").addClass("fa-caret-down");
			$(".app_screening").hide();
			$(".app_screening .screening_ul").hide();
		} else {
			if ($(this).hasClass("active")) {
				arrTypes[parseInt($(this).attr("num"))] = "";
				$(this).removeClass("active");
			} else {
				arrTypes[parseInt($(this).attr("num"))] = $(this).attr("value");
				$(this).addClass("active");
			}
			$("#cardtype").val(arrTypes.join(","));
		}
		searchFun(1);
	});
	// 搜索地区
	$(".app_screening .screening_dq_body_left .screening_dq_li").click(function() {
		// 显示区域
		$(".screening_dq_body_right").hide();
		$(".screening_dq_body_middle").show();
		// 设置选中
		$(".screening_dq_body_left .screening_dq_li").css("color", "#000");
		$(".app_bottom_header .header_bottom_right span").html($(this).css("color", "#009aff").attr("text"));
		// 城市id
		$("#shopid").val("");
		$("#areaid").attr("text", "").val("");
		$("#cityid").attr("text", $(this).attr("text")).val($(this).attr("value"));
		// 请求区域
		$.ajax({
			url: "/api/shopAreaByCityid?cityid=" + $(this).attr("value"),
			type: "get",
			success: function(msg) {
				// 请求区域是否成功
				if (!msg.errcode) {
					// 清除列表
					$(".screening_dq_body_middle").html("");
					// 加全部选项
					msg.errmsg.unshift({ Innerid: '', Countyname: '全部' });
					// 循环出区域列表
					for (var i=0; i < msg.errmsg.length; i++) {
						$(".screening_dq_body_middle").append(
							$("<div></div>")
							.addClass("screening_dq_li")
							.attr("value", msg.errmsg[i].Innerid)
							.attr("text", msg.errmsg[i].Countyname)
							.append(
								$("<div></div>")
								.addClass("dq_li_text")
								.html(msg.errmsg[i].Countyname)
								.append(
									$("<i></i>").addClass("fa fa-angle-right")
								)
							)
						);
					}
					// 选择区域
					$(".screening_dq_body_middle .screening_dq_li").click(function() {
						// 显示店铺
						$(".screening_dq_body_right").show();
						$(".screening_dq_body_middle .screening_dq_li").css("color", "#000");
						$(".app_bottom_header .header_bottom_right span").html($(this).css("color", "#009aff").attr("text"));
						// 区域id
						$("#shopid").val("");
						$("#areaid").attr("text", $(this).attr("text")).val($(this).attr("value"));
						if ($(this).attr("value")) {
							if ($("#type").val() == "1") {
								// 请求店铺
								$.ajax({
									url: "/api/shopByArea?areaid=" + $(this).attr("value"),
									type: "get",
									success: function(msg) {
										if (!msg.errcode) {
											if (msg.errmsg.length) {
												$(".screening_dq_body_right").html("");
												msg.errmsg.unshift({ Value: '', Text: '全部' });
												for (var i=0; i < msg.errmsg.length; i++) {
													$(".screening_dq_body_right").append(
														$("<div></div>")
														.addClass("screening_dq_li")
														.attr("value", msg.errmsg[i].Value)
														.attr("text", msg.errmsg[i].Text)
														.append(
															$("<div></div>")
															.addClass("dq_li_text")
															.html(msg.errmsg[i].Text)
														)
													);
												}
												// 选择店铺
												$(".screening_dq_body_right .screening_dq_li").click(function() {
													$(".screening_dq_body_right .screening_dq_li").css("color", "#000");
													$(".app_bottom_header .header_bottom_right span").html((function ($this) {
														$this.css("color", "#009aff");
														if ($this.attr("value")) {
															return $this.attr("text");
														} else {
															if ($("#areaid").val()) {
																return $("#areaid").attr("text");
															} else {
																return $("#cityid").attr("text");
															}
														}
													})($(this)));
													$("#shopid").val($(this).attr("value"));
													$(".app_bottom_header div[class^='header_bottom_']").css("color", "#666").find(".header_bottom_text").css("color", "#666");
													$(".app_bottom_header div[class^='header_bottom_']").find(".fa").removeClass("fa-caret-up").addClass("fa-caret-down");
													$(".app_screening").hide();
													$(".app_screening .screening_dq").hide();
													searchFun(1);
												});
											} else {
												$(".screening_dq_body_right").hide();
												$(".app_bottom_header div[class^='header_bottom_']").css("color", "#666").find(".header_bottom_text").css("color", "#666");
												$(".app_bottom_header div[class^='header_bottom_']").find(".fa").removeClass("fa-caret-up").addClass("fa-caret-down");
												$(".app_screening").hide();
												$(".app_screening .screening_dq").hide();
												searchFun(1);
											}
										} else {
											alert("根据区域获取店铺失败");
										}
									}
								});
							} else {
								$(".app_bottom_header div[class^='header_bottom_']").css("color", "#666").find(".header_bottom_text").css("color", "#666");
								$(".app_bottom_header div[class^='header_bottom_']").find(".fa").removeClass("fa-caret-up").addClass("fa-caret-down");
								$(".app_screening").hide();
								$(".app_screening .screening_dq").hide();
								searchFun(1);
							}
						} else {
							$(".app_bottom_header .header_bottom_right span").html($("#cityid").attr("text"));
							$(".app_bottom_header div[class^='header_bottom_']").css("color", "#666").find(".header_bottom_text").css("color", "#666");
							$(".app_bottom_header div[class^='header_bottom_']").find(".fa").removeClass("fa-caret-up").addClass("fa-caret-down");
							$(".app_screening").hide();
							$(".app_screening .screening_dq").hide();
							searchFun(1);
						}
					});
				} else {
					alert("根据城市获取区域失败");
				}
			}
		});
	});
	// 绑定
	$(".body_nav_left, .body_nav_right").click(function() {
		// 获得类型
		var type = $(this).attr("val");
		// 自动跳转
		setTimeout(function() {
			self.location = "/open/mallCouponPageList?type=" + type;
		}, 10);
	});
	// 是否状态保持当前页
	if (sessionStorage.ztbc == "true") {
		// 初始化条件
		if (sessionStorage.title) {
			$(".input_search").val(sessionStorage.title);
			$(".app_bottom .app_bottom_body").addClass("active");
		}
		// 刷新当前页面
		searchFun(1);
	} else {
		delete sessionStorage.title;
		delete sessionStorage.ztbc;
	}
}